<!DOCTYPE html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Site Icons -->
   <link rel="shortcut icon" href="static/images/fevicon.ico.png" type="image/x-icon" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}">
    
    <!-- To render Map -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://apis.mapmyindia.com/advancedmaps/v1/dz9ywshne8w983x99tgbnes2rh37h2h6/map_load?v=1.3"></script>
    {% if title %}
        <title>Hospital - {{ title }}</title>
    {% else %}
        <title>Hospital</title>
    {% endif %}
    <style>

      #map_of_my_location {
        height: 890px;
        width: 1835px;
      }

      .alert {
      padding: 20px;
      text-align: center;
      background-color: #CCCC00;
      color: black;
      }

    .closebtn {
      margin-left: 15px;
      color: black;
      font-weight: bold;
      float: right;
      font-size: 22px;
      line-height: 20px;
      cursor: pointer;
      transition: 0.3s;
      }

    .closebtn:hover {
      color: black;
      }
    </style>
</head>
<body>
    <header class="site-header">
      <nav class="navbar navbar-expand-md navbar-dark bg-steel fixed-top">
        <div class="container">
          <a class="navbar-brand mr-4" href="/">Hospital</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggle" aria-controls="navbarToggle" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarToggle">
            <div class="navbar-nav mr-auto">
              <a class="nav-item nav-link" href="{{ url_for('home') }}">Home</a>
              <a class="nav-item nav-link" href="{{ url_for('about') }}">About</a>
            </div>
            <!-- Navbar Right Side -->
            <div class="navbar-nav">
              {% if current_user.is_authenticated %}
                <a class="nav-item nav-link" href="{{ url_for('account') }}">Account</a>
                <a class="nav-item nav-link" href="{{ url_for('logout') }}">Logout</a>
              {% else %}
                <a class="nav-item nav-link" href="{{ url_for('login') }}">Login</a>
                <a class="nav-item nav-link" href="{{ url_for('register') }}">Register</a>
              {% endif %}
            </div>
          </div>
        </div>
      </nav>
    </header>
    <main role="main" class="container">
      <div class="row">
        <div class="col-md-8">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                  {{ message }}
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </main>
    {% if current_user.is_authenticated %}
    <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{{ url_for('nearby_hospital_map') }}">Hospitals near me</a>
    </br><a class="btn btn-secondary btn-sm mt-1 mb-1" href="{{ url_for('nearby_medical_stores_map') }}">Pharmacy near me</a>
  </br>
    <div id="map_of_my_location"></div>
    <script>
      let lat;
      let lon;
      let token = "6026ec9d-98f6-4aa2-bffe-77d65aee8343";
      let key = "blood bank";
      let p_lat = [];
      let p_lng = [];
      navigator.geolocation.getCurrentPosition(function (position) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;

        var map = new MapmyIndia.Map("map_of_my_location", {
          center: [lat, lon],
          zoomControl: true,
          hybrid: true,
        });

        // L.marker([lat, lon]).addTo(map);

        //   var url =
        //     "https://cors-anywhere.herokuapp.com/https://atlas.mapmyindia.com/api/places/nearby/json?keywords=" +
        //     key +
        //     "&refLocation=" +
        //     lat +
        //     "," +
        //     lon +
        //     "";
        //   console.log(url);
        //   $(function () {
        //     $.ajax({
        //       url: url,
        //       headers: {
        //         Authorization: "Bearer " + token,
        //       },
        //       dataType: "json",
        //       type: "GET",
        //       crossDomain: true,
        //       success: function (data) {
        //         $(data.articles).each(function (index, value) {
        //           L.marker([value.latitude, value.longitude]).addTo(map);
        //           console.log(value);
        //         });
        //       },
        //       error: function () {
        //         console.log("error occured!!!!");
        //       },
        //     });
        //   });
        var set = {
          url:
            "https://cors-anywhere.herokuapp.com/https://outpost.mapmyindia.com/api/security/oauth/token?grant_type=client_credentials&client_id=C8W6WwwuliJkpunI5fldW6V6eZFyBwwXUdvysjkH65YYR-Xo661q3dLjQYgHw4Lmzo71qRTLU70=&client_secret=ebEc8GH231fvQStEAnbSKgtWqmd9mNyHx7FBdEy7bjZfYzE42aY9RMhD3esD3LeclpKLJmbLoXfKi86NVj5G6A==",
          method: "POST",
          timeout: 0,
        };

        $.ajax(set).done(function (response) {
          token = response.access_token;

          //   console.log(token);

          var settings = {
            url:
              "https://cors-anywhere.herokuapp.com/https://atlas.mapmyindia.com/api/places/nearby/json?keywords=" +
              key +
              "&refLocation=" +
              lat +
              "," +
              lon +
              "&access_token=" +
              token +
              "&token_type=bearer",
            method: "GET",
            timeout: 0,
          };

          $.ajax(settings).done(function (response) {
            var data = response;
            len = Object.keys(data.suggestedLocations).length;

            // console.log("data----->?", data);
            for (let i = 0; i < len; i++) {
              //console.log(data.suggestedLocations[i].latitude)
              p_lat[i] = data.suggestedLocations[i].latitude;
              p_lng[i] = data.suggestedLocations[i].longitude;
            }
            //console.log(p_lat);
            markerIcon = L.icon({
              iconUrl: "https://maps.mapmyindia.com/images/2.png",
              iconSize: [30, 30],
              iconAnchor: [12, -10],
            });

            for (let i = 0; i < len; i++) {
              // console.log(data.suggestedLocations[i].placeAddress);
              // console.log(p_lat[i]);
              // console.log(p_lng[i]);
              new L.marker([p_lat[i], p_lng[i]], { icon: markerIcon })
                .addTo(map)
                .bindPopup(data.suggestedLocations[i].placeAddress);
            }
          });
        });
      });
    </script>
    {% else %}
      <div class="alert">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span> 
      <strong> Please login first to avail the functionality </strong>
      </div>
    {% endif %}
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>

